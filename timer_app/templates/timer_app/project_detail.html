{% extends "timer_app/base.html" %}
{% load timer_filters %}

{% block title %}{{ project.name }} - Timer Tracker{% endblock %}

{% block breadcrumb %}
<div class="breadcrumb">
    <a href="{% url 'home' %}">Home</a>
    <span>â€º</span>
    <a href="{% url 'customer_list' %}">Customers</a>
    <span>â€º</span>
    <a href="{% url 'customer_detail' project.customer.pk %}">{{ project.customer.name }}</a>
    <span>â€º</span>
    <span>{{ project.name }}</span>
</div>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">{{ project.name }}</h1>
    <div class="actions">
        {% if project.status == 'active' %}
        <a href="{% url 'timer_assign_to_project' %}?project={{ project.pk }}" class="btn btn-success">Assign Timer</a>
        <a href="{% url 'project_complete' project.pk %}" class="btn">Mark Complete</a>
        {% endif %}
        <a href="{% url 'project_edit' project.pk %}" class="btn btn-secondary">Edit</a>
    </div>
</div>

<div class="card">
    <h3>Details</h3>
    <p><strong>Customer:</strong> <a href="{% url 'customer_detail' project.customer.pk %}">{{ project.customer.name }}</a></p>
    <p><strong>Status:</strong> 
        <span class="status-badge status-{{ project.status }}">
            {{ project.get_status_display }}
        </span>
    </p>
    <p><strong>Total Time:</strong> {{ project.total_duration_seconds|format_duration }}</p>
    <p><strong>Total Cost:</strong> {{ project.total_cost|format_currency }}</p>
    <p><strong>Timers:</strong> {{ project_timers.count }}</p>
</div>

{% if project.status == 'completed' %}
<div class="message info" style="margin-top: 1rem;">
    This project is completed. You cannot start new timers on completed projects.
</div>
{% endif %}

<h2 style="margin-top: 2rem; margin-bottom: 1rem;">Timers</h2>

{% if project_timers %}
<div class="timer-grid">
    {% for project_timer in project_timers %}
    <div class="timer-card" data-timer-id="{{ project_timer.pk }}">
        <div class="timer-card-header">
            <h3 class="timer-task-name">{{ project_timer.timer.task_name }}</h3>
            <span class="timer-status {% if project_timer.is_running %}status-running{% else %}status-stopped{% endif %}">
                {% if project_timer.is_running %}RUNNING{% else %}STOPPED{% endif %}
            </span>
        </div>
        
        <div class="timer-card-body">
            <div class="timer-info">
                <div class="timer-info-item">
                    <span class="timer-label">Rate:</span>
                    <span class="timer-value">{{ project_timer.timer.price_per_hour|format_currency }}/hr</span>
                </div>
                <div class="timer-info-item">
                    <span class="timer-label">Total Time:</span>
                    <span class="timer-value timer-total">{{ project_timer.total_duration_seconds|format_duration }}</span>
                </div>
                <div class="timer-info-item">
                    <span class="timer-label">Total Cost:</span>
                    <span class="timer-value">{{ project_timer.total_cost|format_currency }}</span>
                </div>
            </div>
            
            {% if project_timer.is_running %}
            <div class="timer-current-session">
                <span class="timer-label">Current Session:</span>
                <span class="live-timer" data-timer-id="{{ project_timer.pk }}" data-start-time="{{ project_timer.active_session.start_time.isoformat }}">
                    00:00:00
                </span>
            </div>
            {% endif %}
            
            <div class="timer-actions">
                {% if project.status == 'active' %}
                    {% if project_timer.is_running %}
                    <button class="btn btn-danger btn-timer-action stop-timer" data-timer-id="{{ project_timer.pk }}">
                        <i class="far fa-pause-circle"></i> Stop Timer
                    </button>
                    {% else %}
                    <button class="btn btn-success btn-timer-action start-timer" data-timer-id="{{ project_timer.pk }}">
                        <i class="far fa-play-circle"></i> Start Timer
                    </button>
                    {% endif %}
                {% endif %}
                
                <div class="timer-footer-actions">
                    <button class="btn-link toggle-sessions" data-timer-id="{{ project_timer.pk }}">
                        <span class="toggle-icon">â–¼</span> View Sessions ({{ project_timer.sessions.count }})
                    </button>
                    {% if is_owner %}
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <a href="{% url 'project_timer_remove' project_timer.pk %}" class="btn btn-small btn-danger">Remove</a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="timer-sessions-container" id="sessions-{{ project_timer.pk }}" style="display: none;">
            <div class="sessions-header">
                <h4>Sessions</h4>
            </div>
            {% if project_timer.sessions.all %}
            <div class="sessions-list">
                {% for session in project_timer.sessions.all %}
                <div class="session-item">
                    <div class="session-time">
                        <div class="session-detail">
                            <strong>Started:</strong> {{ session.start_time|date:"M d, Y H:i" }}
                        </div>
                        <div class="session-detail">
                            <strong>Ended:</strong> 
                            {% if session.end_time %}
                                {{ session.end_time|date:"M d, Y H:i" }}
                            {% else %}
                                <span class="timer-running">ACTIVE</span>
                            {% endif %}
                        </div>
                        {% if has_team_members and session.created_by %}
                        <div class="session-creator-tag">
                            ðŸ‘¤ {{ session.created_by.username }}
                        </div>
                        {% endif %}
                    </div>
                    <div class="session-stats">
                        <span class="session-duration">{{ session.duration_seconds|format_duration }}</span>
                        <div class="session-cost-container">
                            <span class="session-cost">{{ session.cost|format_currency }}</span>
                            <span class="session-rate-recorded">Recorded at {{ session.price_per_hour|format_currency }}/hr</span>
                        </div>
                    </div>
                    <div class="session-note-container">
                        <label style="font-weight: 600; color: #666; font-size: 0.875rem; display: block; margin-bottom: 0.25rem;">Note:</label>
                        <div class="session-note-editable" 
                             contenteditable="true" 
                             data-session-id="{{ session.pk }}"
                             data-original-note="{{ session.note }}"
                             placeholder="Click to add a note...">{{ session.note }}</div>
                        <div class="session-note-hint">Click to edit â€¢ Changes save automatically</div>
                    </div>
                    <div class="session-actions">
                        <a href="{% url 'session_edit' session.pk %}" class="btn btn-small btn-secondary">Edit Time</a>
                        {% if is_owner %}
                        <button class="btn btn-small btn-danger delete-session" data-session-id="{{ session.pk }}">Delete Session</button>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p style="padding: 1rem; color: #999;">No sessions yet</p>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="card">
    <p>No timers yet. 
        {% if project.status == 'active' %}
        <a href="{% url 'timer_assign_to_project' %}?project={{ project.pk }}">Assign your first timer</a>
        {% endif %}
    </p>
</div>
{% endif %}

<!-- Note Modal -->
<div id="noteModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">Add Session Note</div>
        <div class="form-group">
            <label for="sessionNote" class="form-label">What did you work on?</label>
            <textarea id="sessionNote" class="form-textarea" rows="4" placeholder="Describe what you worked on..."></textarea>
        </div>
        <div class="modal-footer">
            <button id="saveNote" class="btn">Save</button>
            <button id="cancelNote" class="btn btn-secondary">Cancel</button>
        </div>
    </div>
</div>

<!-- Delete Session Confirmation Modal -->
<div id="deleteSessionModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">Delete Session</div>
        <p style="margin: 1rem 0;">Are you sure you want to delete this session? This action cannot be undone.</p>
        <div class="modal-footer">
            <button id="confirmDeleteSession" class="btn btn-danger">Yes, Delete</button>
            <button id="cancelDeleteSession" class="btn btn-secondary">Cancel</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentSessionId = null;
    let editingSessionId = null;

    // Update live timers
    function updateLiveTimers() {
        const timers = document.querySelectorAll('.live-timer');
        timers.forEach(timer => {
            const startTime = new Date(timer.dataset.startTime);
            const now = new Date();
            const seconds = Math.floor((now - startTime) / 1000);
            timer.textContent = formatDuration(seconds);
        });
    }

    function formatDuration(seconds) {
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = seconds % 60;
        return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
    }

    // Toggle sessions dropdown
    document.querySelectorAll('.toggle-sessions').forEach(button => {
        button.addEventListener('click', function() {
            const timerId = this.dataset.timerId;
            const sessionsContainer = document.getElementById(`sessions-${timerId}`);
            const toggleIcon = this.querySelector('.toggle-icon');
            
            if (sessionsContainer.style.display === 'none') {
                sessionsContainer.style.display = 'block';
                sessionsContainer.classList.add('expanded');
                toggleIcon.classList.add('rotated');
            } else {
                sessionsContainer.style.display = 'none';
                sessionsContainer.classList.remove('expanded');
                toggleIcon.classList.remove('rotated');
            }
        });
    });

    // Start timer
    document.querySelectorAll('.start-timer').forEach(button => {
        button.addEventListener('click', function() {
            const timerId = this.dataset.timerId;
            
            fetch(`/project-timers/${timerId}/start/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred starting the timer');
            });
        });
    });

    // Stop timer
    document.querySelectorAll('.stop-timer').forEach(button => {
        button.addEventListener('click', function() {
            const timerId = this.dataset.timerId;
            
            fetch(`/project-timers/${timerId}/stop/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentSessionId = data.session_id;
                    document.getElementById('noteModal').classList.add('active');
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred stopping the timer');
            });
        });
    });

    // Save note (for new session)
    document.getElementById('saveNote').addEventListener('click', function() {
        const note = document.getElementById('sessionNote').value;
        
        fetch(`/sessions/${currentSessionId}/note/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ note: note })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred saving the note');
        });
    });

    // Cancel note
    document.getElementById('cancelNote').addEventListener('click', function() {
        document.getElementById('noteModal').classList.remove('active');
        document.getElementById('sessionNote').value = '';
        location.reload();
    });

    // Inline edit session notes
    let saveTimeout = null;
    document.querySelectorAll('.session-note-editable').forEach(noteElement => {
        // Save on blur (when user clicks away)
        noteElement.addEventListener('blur', function() {
            const sessionId = this.dataset.sessionId;
            const originalNote = this.dataset.originalNote;
            const newNote = this.textContent.trim();
            
            // Only save if changed
            if (newNote !== originalNote) {
                this.classList.add('saving');
                
                fetch(`/sessions/${sessionId}/note/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ note: newNote })
                })
                .then(response => response.json())
                .then(data => {
                    this.classList.remove('saving');
                    if (data.success) {
                        this.dataset.originalNote = newNote;
                        // Show a brief success indicator
                        const hint = this.parentElement.querySelector('.session-note-hint');
                        const originalText = hint.textContent;
                        hint.textContent = 'âœ“ Saved';
                        hint.style.color = '#27ae60';
                        setTimeout(() => {
                            hint.textContent = originalText;
                            hint.style.color = '#999';
                        }, 2000);
                    } else {
                        alert('Error: ' + data.error);
                        this.textContent = originalNote;
                    }
                })
                .catch(error => {
                    this.classList.remove('saving');
                    console.error('Error:', error);
                    alert('An error occurred saving the note');
                    this.textContent = originalNote;
                });
            }
        });
        
        // Also save on Enter key (but don't add line break)
        noteElement.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                this.blur(); // Trigger save
            }
        });
    });

    // Delete session - show modal
    let deletingSessionId = null;
    document.querySelectorAll('.delete-session').forEach(button => {
        button.addEventListener('click', function() {
            deletingSessionId = this.dataset.sessionId;
            document.getElementById('deleteSessionModal').classList.add('active');
        });
    });

    // Confirm delete session
    document.getElementById('confirmDeleteSession').addEventListener('click', function() {
        if (!deletingSessionId) return;
        
        fetch(`/sessions/${deletingSessionId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('deleteSessionModal').classList.remove('active');
                location.reload();
            } else {
                alert('Error: ' + (data.error || 'Failed to delete session'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred deleting the session');
        });
    });

    // Cancel delete session
    document.getElementById('cancelDeleteSession').addEventListener('click', function() {
        document.getElementById('deleteSessionModal').classList.remove('active');
        deletingSessionId = null;
    });

    // Close modals when clicking outside
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.remove('active');
            }
        });
    });

    // Close modals with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            document.querySelectorAll('.modal.active').forEach(modal => {
                modal.classList.remove('active');
            });
        }
    });

    // Update live timers every second
    setInterval(updateLiveTimers, 1000);
    updateLiveTimers();
</script>
{% endblock %}

