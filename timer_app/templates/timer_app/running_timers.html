{% extends "timer_app/base.html" %}
{% load timer_filters %}

{% block title %}Running Timers - Timer Tracker{% endblock %}

{% block breadcrumb %}
<div class="breadcrumb">
    <a href="{% url 'home' %}">Home</a>
    <span>›</span>
    <span>Running Timers</span>
</div>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Running Timers</h1>
</div>

{% if active_sessions %}
<div class="timer-grid">
    {% for session in active_sessions %}
    <div class="timer-card">
        <div class="timer-card-header">
            <h3 class="timer-task-name">{{ session.timer.task_name }}</h3>
            <span class="timer-status status-running">RUNNING</span>
        </div>
        
        <div class="timer-card-body">
            <div class="timer-info">
                <div class="timer-info-item">
                    <span class="timer-label">Customer:</span>
                    <span class="timer-value">
                        <a href="{% url 'customer_detail' session.timer.project.customer.pk %}">
                            {{ session.timer.project.customer.name }}
                        </a>
                    </span>
                </div>
                <div class="timer-info-item">
                    <span class="timer-label">Project:</span>
                    <span class="timer-value">
                        <a href="{% url 'project_detail' session.timer.project.pk %}">
                            {{ session.timer.project.name }}
                        </a>
                    </span>
                </div>
                <div class="timer-info-item">
                    <span class="timer-label">Rate:</span>
                    <span class="timer-value">{{ session.timer.price_per_hour|format_currency }}/hr</span>
                </div>
                <div class="timer-info-item">
                    <span class="timer-label">Started:</span>
                    <span class="timer-value">{{ session.start_time|date:"M d, Y H:i" }}</span>
                </div>
            </div>
            
            <div class="timer-current-session">
                <span class="timer-label">Current Duration:</span>
                <span class="live-timer" data-timer-id="{{ session.timer.pk }}" data-start-time="{{ session.start_time.isoformat }}">
                    00:00:00
                </span>
            </div>
            
            <div class="timer-actions">
                <button class="btn btn-danger btn-timer-action stop-timer" data-timer-id="{{ session.timer.pk }}">
                    <span>⏸</span> Stop Timer
                </button>
                <div class="timer-footer-actions">
                    <a href="{% url 'project_detail' session.timer.project.pk %}" class="btn-link">Go to Project →</a>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="card">
    <p>No timers are currently running. <a href="{% url 'customer_list' %}">Go to customers</a> to start tracking time!</p>
</div>
{% endif %}

<!-- Note Modal -->
<div id="noteModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">Add Session Note</div>
        <div class="form-group">
            <label for="sessionNote" class="form-label">What did you work on?</label>
            <textarea id="sessionNote" class="form-textarea" rows="4" placeholder="Describe what you worked on..."></textarea>
        </div>
        <div class="modal-footer">
            <button id="saveNote" class="btn">Save</button>
            <button id="cancelNote" class="btn btn-secondary">Cancel</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentSessionId = null;

    // Update live timers
    function updateLiveTimers() {
        const timers = document.querySelectorAll('.live-timer');
        timers.forEach(timer => {
            const startTime = new Date(timer.dataset.startTime);
            const now = new Date();
            const seconds = Math.floor((now - startTime) / 1000);
            timer.textContent = formatDuration(seconds);
        });
    }

    function formatDuration(seconds) {
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = seconds % 60;
        return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
    }

    // Stop timer
    document.querySelectorAll('.stop-timer').forEach(button => {
        button.addEventListener('click', function() {
            const timerId = this.dataset.timerId;
            
            fetch(`/timers/${timerId}/stop/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentSessionId = data.session_id;
                    document.getElementById('noteModal').classList.add('active');
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred stopping the timer');
            });
        });
    });

    // Save note
    document.getElementById('saveNote').addEventListener('click', function() {
        const note = document.getElementById('sessionNote').value;
        
        fetch(`/sessions/${currentSessionId}/note/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ note: note })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred saving the note');
        });
    });

    // Cancel note
    document.getElementById('cancelNote').addEventListener('click', function() {
        document.getElementById('noteModal').classList.remove('active');
        document.getElementById('sessionNote').value = '';
        location.reload();
    });

    // Close modals when clicking outside
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.remove('active');
            }
        });
    });

    // Close modals with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            document.querySelectorAll('.modal.active').forEach(modal => {
                modal.classList.remove('active');
            });
        }
    });

    // Update live timers every second
    setInterval(updateLiveTimers, 1000);
    updateLiveTimers();
</script>
{% endblock %}

