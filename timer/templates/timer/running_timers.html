{% extends "timer/base.html" %}
{% load timer_filters %}

{% block title %}Running Timers - Timer Tracker{% endblock %}

{% block breadcrumb %}
<div class="breadcrumb">
    <a href="{% url 'home' %}">Home</a>
    <span>›</span>
    <span>Running Timers</span>
</div>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Running Timers</h1>
</div>

{% if active_sessions %}
<div class="timer-grid">
    {% for session in active_sessions %}
    <div class="timer-card">
        <div class="timer-card-header" style="background-color: {{ session.project_timer.timer.header_color|default:'#3498db' }};">
            <h3 class="timer-task-name">{{ session.project_timer.timer.task_name }}</h3>
            <span class="timer-status {% if session.is_paused %}status-paused{% else %}status-running{% endif %}">
                {% if session.is_paused %}PAUSED{% else %}RUNNING{% endif %}
            </span>
        </div>
        
        <div class="timer-card-body">
            <div class="timer-info">
                <div class="timer-info-item">
                    <span class="timer-label">Customer:</span>
                    <span class="timer-value">
                        <a href="{% url 'customer_detail' session.project_timer.project.customer.pk %}">
                            {{ session.project_timer.project.customer.name }}
                        </a>
                    </span>
                </div>
                <div class="timer-info-item">
                    <span class="timer-label">Project:</span>
                    <span class="timer-value">
                        <a href="{% url 'project_detail' session.project_timer.project.pk %}">
                            {{ session.project_timer.project.name }}
                        </a>
                    </span>
                </div>
                <div class="timer-info-item">
                    <span class="timer-label">Rate:</span>
                    <span class="timer-value">{{ session.price_per_hour|format_currency }}/hr</span>
                </div>
                <div class="timer-info-item">
                    <span class="timer-label">Started:</span>
                    <span class="timer-value">{{ session.start_time|date:"M d, Y H:i" }}</span>
                </div>
            </div>
            
            <div class="timer-current-session">
                <span class="timer-label">Current Duration:</span>
                {% if session.is_paused %}
                <span class="timer-paused-display">{{ session.duration_seconds|format_duration }}</span>
                <span style="color: #e67e22; font-size: 0.875rem; margin-left: 0.5rem;">(Paused)</span>
                {% else %}
                <span class="live-timer" 
                      data-timer-id="{{ session.project_timer.pk }}" 
                      data-start-time="{{ session.start_time.isoformat }}"
                      data-pauses="{% for pause in session.pauses.all %}{{ pause.pause_start_time.isoformat }},{{ pause.pause_end_time.isoformat }};{% endfor %}">
                    00:00:00
                </span>
                {% endif %}
            </div>
            
            <div class="timer-actions">
                {% if session.is_paused %}
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn btn-success btn-timer-action resume-timer" data-timer-id="{{ session.project_timer.pk }}">
                        <i class="far fa-play-circle"></i> Resume
                    </button>
                    <button class="btn btn-danger btn-timer-action stop-timer" data-timer-id="{{ session.project_timer.pk }}" data-project-id="{{ session.project_timer.project.pk }}">
                        <i class="far fa-stop-circle"></i> Stop
                    </button>
                </div>
                {% else %}
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn btn-warning btn-timer-action pause-timer" data-timer-id="{{ session.project_timer.pk }}">
                        <i class="far fa-pause-circle"></i> Pause
                    </button>
                    <button class="btn btn-danger btn-timer-action stop-timer" data-timer-id="{{ session.project_timer.pk }}" data-project-id="{{ session.project_timer.project.pk }}">
                        <i class="far fa-stop-circle"></i> Stop
                    </button>
                </div>
                {% endif %}
                <div class="timer-footer-actions">
                    <a href="{% url 'project_detail' session.project_timer.project.pk %}" class="btn-link">Go to Project →</a>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="card">
    <p>No timers are currently running. <a href="{% url 'customer_list' %}">Go to customers</a> to start tracking time!</p>
</div>
{% endif %}

<!-- Note Modal -->
<div id="noteModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">Add Session Note</div>
        <div id="modalErrorMessage" style="display: none; margin: 1rem; padding: 0.75rem; background: #fee; border: 1px solid #fcc; border-radius: 4px; color: #c33; font-size: 0.875rem;"></div>
        <div class="form-group">
            <label for="sessionDeliverable" class="form-label">Deliverable (optional):</label>
            <select id="sessionDeliverable" class="form-input">
                <option value="">No deliverable</option>
                <option value="__add_new__">➕ Add new deliverable...</option>
            </select>
            <div id="addDeliverableInline" style="display: none; margin-top: 0.75rem; padding: 1rem; background: #f5f5f5; border-radius: 4px;">
                <div id="deliverableError" style="display: none; margin-bottom: 0.75rem; padding: 0.5rem; background: #fee; border: 1px solid #fcc; border-radius: 4px; color: #c33; font-size: 0.875rem;"></div>
                <div class="form-group" style="margin-bottom: 0.75rem;">
                    <label for="newDeliverableName" class="form-label" style="font-size: 0.875rem;">Deliverable Name:</label>
                    <input type="text" id="newDeliverableName" class="form-input" placeholder="e.g., Video 1, Kitchen wall, Landing page">
                </div>
                <div class="form-group" style="margin-bottom: 0.75rem;">
                    <label for="newDeliverableDescription" class="form-label" style="font-size: 0.875rem;">Description (optional):</label>
                    <textarea id="newDeliverableDescription" class="form-input" rows="2" placeholder="Optional description..."></textarea>
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    <button type="button" id="createDeliverableBtn" class="btn" style="flex: 1;">Create & Select</button>
                    <button type="button" id="cancelAddDeliverableBtn" class="btn btn-secondary">Cancel</button>
                </div>
            </div>
        </div>
        <div class="form-group">
            <label for="sessionNote" class="form-label">What did you work on?</label>
            <textarea id="sessionNote" class="form-textarea" rows="4" placeholder="Describe what you worked on..."></textarea>
        </div>
        <div class="modal-footer">
            <button id="saveNote" class="btn">Save</button>
            <button id="cancelNote" class="btn btn-secondary">Cancel</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentSessionId = null;
    let currentProjectId = null;

    // Update live timers
    function updateLiveTimers() {
        const timers = document.querySelectorAll('.live-timer');
        timers.forEach(timer => {
            const startTime = new Date(timer.dataset.startTime);
            const now = new Date();
            let seconds = Math.floor((now - startTime) / 1000);
            
            // Subtract pause periods
            const pausesData = timer.dataset.pauses;
            if (pausesData) {
                const pauses = pausesData.split(';').filter(p => p.trim() !== '');
                pauses.forEach(pauseStr => {
                    if (pauseStr.includes(',')) {
                        const [pauseStartStr, pauseEndStr] = pauseStr.split(',');
                        const pauseStart = new Date(pauseStartStr);
                        const pauseEnd = new Date(pauseEndStr);
                        
                        // Only subtract if the pause period overlaps with the current time period
                        // Pause duration is the time between pause start and pause end
                        const pauseDuration = Math.floor((pauseEnd - pauseStart) / 1000);
                        seconds -= pauseDuration;
                    }
                });
            }
            
            // Ensure non-negative
            seconds = Math.max(0, seconds);
            timer.textContent = formatDuration(seconds);
        });
    }

    function formatDuration(seconds) {
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = seconds % 60;
        return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
    }

    // Load deliverables for a project
    function loadDeliverables(projectId) {
        const select = document.getElementById('sessionDeliverable');
        // Clear existing options except "No deliverable" and "Add new"
        while (select.children.length > 2) {
            select.removeChild(select.children[1]);
        }
        
        fetch(`/projects/${projectId}/deliverables/?format=json`, {
            headers: {
                'Accept': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Add deliverables before "Add new" option
                const addNewOption = select.lastElementChild;
                data.deliverables.forEach(d => {
                    const option = document.createElement('option');
                    option.value = d.id;
                    option.textContent = d.name;
                    select.insertBefore(option, addNewOption);
                });
            }
        })
        .catch(error => {
            console.error('Error loading deliverables:', error);
        });
    }

    // Pause timer
    document.querySelectorAll('.pause-timer').forEach(button => {
        button.addEventListener('click', function() {
            const timerId = this.dataset.timerId;
            
            fetch(`/project-timers/${timerId}/pause/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred pausing the timer');
            });
        });
    });

    // Resume timer
    document.querySelectorAll('.resume-timer').forEach(button => {
        button.addEventListener('click', function() {
            const timerId = this.dataset.timerId;
            
            fetch(`/project-timers/${timerId}/resume/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred resuming the timer');
            });
        });
    });

    // Stop timer
    document.querySelectorAll('.stop-timer').forEach(button => {
        button.addEventListener('click', function() {
            const timerId = this.dataset.timerId;
            
            fetch(`/project-timers/${timerId}/stop/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentSessionId = data.session_id;
                    currentProjectId = data.project_id;
                    
                    // Clear any previous errors when opening modal
                    document.getElementById('modalErrorMessage').style.display = 'none';
                    document.getElementById('modalErrorMessage').textContent = '';
                    document.getElementById('deliverableError').style.display = 'none';
                    document.getElementById('deliverableError').textContent = '';
                    document.getElementById('sessionNote').value = '';
                    document.getElementById('sessionDeliverable').value = '';
                    document.getElementById('addDeliverableInline').style.display = 'none';
                    const saveBtn = document.getElementById('saveNote');
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Save';
                    
                    // Load deliverables for this project
                    loadDeliverables(currentProjectId);
                    
                    document.getElementById('noteModal').classList.add('active');
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred stopping the timer');
            });
        });
    });

    // Handle deliverable dropdown change in modal
    document.getElementById('sessionDeliverable').addEventListener('change', function() {
        const addDeliverableInline = document.getElementById('addDeliverableInline');
        const errorDiv = document.getElementById('deliverableError');
        if (this.value === '__add_new__') {
            addDeliverableInline.style.display = 'block';
            this.value = ''; // Reset to empty so it doesn't interfere
            // Clear any previous errors
            errorDiv.style.display = 'none';
            errorDiv.textContent = '';
        } else {
            addDeliverableInline.style.display = 'none';
            // Clear errors when hiding the form
            errorDiv.style.display = 'none';
            errorDiv.textContent = '';
        }
    });

    // Cancel add deliverable in modal
    document.getElementById('cancelAddDeliverableBtn').addEventListener('click', function() {
        document.getElementById('addDeliverableInline').style.display = 'none';
        document.getElementById('sessionDeliverable').value = '';
        document.getElementById('newDeliverableName').value = '';
        document.getElementById('newDeliverableDescription').value = '';
        // Clear errors
        const errorDiv = document.getElementById('deliverableError');
        errorDiv.style.display = 'none';
        errorDiv.textContent = '';
    });

    // Create deliverable inline in modal
    document.getElementById('createDeliverableBtn').addEventListener('click', function() {
        const name = document.getElementById('newDeliverableName').value.trim();
        const description = document.getElementById('newDeliverableDescription').value.trim();
        const errorDiv = document.getElementById('deliverableError');
        
        // Hide previous errors
        errorDiv.style.display = 'none';
        errorDiv.textContent = '';
        
        if (!name) {
            errorDiv.textContent = 'Please enter a deliverable name';
            errorDiv.style.display = 'block';
            return;
        }

        fetch(`/projects/${currentProjectId}/deliverables/add-ajax/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ name: name, description: description })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Add to dropdown
                const select = document.getElementById('sessionDeliverable');
                const option = document.createElement('option');
                option.value = data.deliverable.id;
                option.textContent = data.deliverable.name;
                select.insertBefore(option, select.lastElementChild); // Insert before "Add new" option
                select.value = data.deliverable.id;
                
                // Hide inline form and clear errors
                document.getElementById('addDeliverableInline').style.display = 'none';
                document.getElementById('newDeliverableName').value = '';
                document.getElementById('newDeliverableDescription').value = '';
                errorDiv.style.display = 'none';
                errorDiv.textContent = '';
            } else {
                errorDiv.textContent = 'Error: ' + (data.error || 'Failed to create deliverable');
                errorDiv.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            errorDiv.textContent = 'An error occurred creating the deliverable';
            errorDiv.style.display = 'block';
        });
    });

    // Handle Enter key in note textarea: Enter = submit, Shift+Enter = new line
    const sessionNoteTextarea = document.getElementById('sessionNote');
    if (sessionNoteTextarea) {
        sessionNoteTextarea.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                // Trigger save button click
                const saveBtn = document.getElementById('saveNote');
                if (saveBtn && !saveBtn.disabled) {
                    saveBtn.click();
                }
            }
            // Shift+Enter allows default behavior (new line)
        });
    }

    // Save note
    document.getElementById('saveNote').addEventListener('click', function() {
        const note = document.getElementById('sessionNote').value;
        const deliverableId = document.getElementById('sessionDeliverable').value;
        const errorDiv = document.getElementById('modalErrorMessage');
        
        // Hide previous errors
        errorDiv.style.display = 'none';
        errorDiv.textContent = '';
        
        // Don't save if "Add new" is selected
        if (deliverableId === '__add_new__') {
            errorDiv.textContent = 'Please create the deliverable first or select an existing one';
            errorDiv.style.display = 'block';
            return;
        }
        
        // Disable save button to prevent double submission
        const saveBtn = document.getElementById('saveNote');
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';
        
        fetch(`/sessions/${currentSessionId}/note/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                note: note,
                deliverable: deliverableId || null
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                // Show error and re-enable button
                errorDiv.textContent = 'Error: ' + (data.error || 'Failed to save session');
                errorDiv.style.display = 'block';
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            errorDiv.textContent = 'An error occurred saving the note';
            errorDiv.style.display = 'block';
            saveBtn.disabled = false;
            saveBtn.textContent = 'Save';
        });
    });

    // Cancel note
    document.getElementById('cancelNote').addEventListener('click', function() {
        // Clear all form data and errors
        document.getElementById('noteModal').classList.remove('active');
        document.getElementById('sessionNote').value = '';
        document.getElementById('sessionDeliverable').value = '';
        document.getElementById('addDeliverableInline').style.display = 'none';
        document.getElementById('newDeliverableName').value = '';
        document.getElementById('newDeliverableDescription').value = '';
        document.getElementById('modalErrorMessage').style.display = 'none';
        document.getElementById('modalErrorMessage').textContent = '';
        document.getElementById('deliverableError').style.display = 'none';
        document.getElementById('deliverableError').textContent = '';
        const saveBtn = document.getElementById('saveNote');
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save';
        // Reload to refresh the page state
        location.reload();
    });

    // Close modals when clicking outside
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.remove('active');
            }
        });
    });

    // Close modals with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            document.querySelectorAll('.modal.active').forEach(modal => {
                modal.classList.remove('active');
            });
        }
    });

    // Update live timers every second
    setInterval(updateLiveTimers, 1000);
    updateLiveTimers();
</script>
{% endblock %}

