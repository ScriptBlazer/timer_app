{% extends "timer/base.html" %}
{% load timer_filters %}

{% block title %}All Projects - Timer Tracker{% endblock %}

{% block breadcrumb %}
<div class="breadcrumb">
    <a href="{% url 'home' %}">Home</a>
    <span>â€º</span>
    <span>All Projects</span>
</div>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">All Projects</h1>
</div>

{% if projects %}
<div class="filter-controls">
    <div class="search-box">
        <input type="text" id="projectSearch" class="form-input" placeholder="ðŸ” Search projects...">
    </div>
    <div class="sort-controls">
        <label class="sort-label">Sort by:</label>
        <button class="sort-btn" data-sort="name">Name</button>
        <button class="sort-btn active" data-sort="recent">Most Recent</button>
    </div>
</div>
<div class="toggle-controls" style="margin-top: 1rem; margin-bottom: 1.5rem; padding: 0 1.25rem;">
    <label class="toggle-label">
        <input type="checkbox" id="showCompleted">
        <span>Show completed projects</span>
    </label>
</div>

<div class="card">
    <table class="table">
        <thead>
            <tr>
                <th>Project Name</th>
                <th>Customer</th>
                <th class="hide-mobile">Status</th>
                <th class="hide-mobile">Timers</th>
                <th class="hide-mobile">Total Time</th>
                <th class="hide-mobile">Total Cost</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for project in projects %}
            <tr class="project-row" data-status="{{ project.status }}" data-name="{{ project.name|lower }}" data-customer="{{ project.customer.name|lower }}" data-original-index="{{ forloop.counter }}">
                <td><a href="{% url 'project_detail' project.pk %}">{{ project.name }}</a></td>
                <td><a href="{% url 'customer_detail' project.customer.pk %}">{{ project.customer.name }}</a></td>
                <td class="hide-mobile">
                    <span class="status-badge status-{{ project.status }}">
                        {{ project.get_status_display }}
                    </span>
                </td>
                <td class="hide-mobile">{{ project.project_timers.count }}</td>
                <td class="hide-mobile">{{ project.total_duration_seconds|format_duration }}</td>
                <td class="hide-mobile">{{ project.total_cost|format_currency }}</td>
                <td class="actions">
                    <a href="{% url 'project_detail' project.pk %}" class="btn btn-small">View</a>
                    <a href="{% url 'project_edit' project.pk %}" class="btn btn-small btn-secondary">Edit</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="card">
    <p>No projects yet. <a href="{% url 'customer_list' %}">Go to customers</a> to add projects.</p>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    // Search projects
    const projectSearch = document.getElementById('projectSearch');
    if (projectSearch) {
        projectSearch.addEventListener('input', function(e) {
            filterProjects();
        });
    }

    // Toggle completed projects
    const showCompleted = document.getElementById('showCompleted');
    if (showCompleted) {
        showCompleted.addEventListener('change', function() {
            filterProjects();
        });
    }

    // Sort projects
    const sortButtons = document.querySelectorAll('.sort-btn');
    const tbody = document.querySelector('.table tbody');
    
    if (tbody && sortButtons.length > 0) {
        sortButtons.forEach(button => {
            button.addEventListener('click', function() {
                // Update active button
                sortButtons.forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                
                const sortType = this.dataset.sort;
                
                // Get all visible rows (after filtering)
                const rows = Array.from(tbody.querySelectorAll('.project-row:not([style*="display: none"])'));
                
                // Sort based on type
                rows.sort((a, b) => {
                    if (sortType === 'name') {
                        // Sort alphabetically by project name
                        const nameA = a.querySelector('td:first-child').textContent.trim().toLowerCase();
                        const nameB = b.querySelector('td:first-child').textContent.trim().toLowerCase();
                        return nameA.localeCompare(nameB);
                    } else {
                        // Sort by original index (most recent first)
                        const indexA = parseInt(a.dataset.originalIndex);
                        const indexB = parseInt(b.dataset.originalIndex);
                        return indexA - indexB;
                    }
                });
                
                // Re-append in sorted order (only visible rows)
                rows.forEach(row => tbody.appendChild(row));
            });
        });
    }

    function filterProjects() {
        const searchTerm = projectSearch ? projectSearch.value.toLowerCase() : '';
        const showCompletedProjects = showCompleted ? showCompleted.checked : false;
        const rows = document.querySelectorAll('.project-row');
        
        rows.forEach(row => {
            const projectName = row.dataset.name;
            const customerName = row.dataset.customer;
            const projectStatus = row.dataset.status;
            
            const matchesSearch = projectName.includes(searchTerm) || customerName.includes(searchTerm);
            const matchesStatus = showCompletedProjects || projectStatus !== 'completed';
            
            if (matchesSearch && matchesStatus) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
        
        // Re-sort after filtering if a sort is active
        const activeSortBtn = document.querySelector('.sort-btn.active');
        if (activeSortBtn) {
            activeSortBtn.click();
        }
    }
</script>
{% endblock %}

