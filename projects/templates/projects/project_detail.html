{% extends "timer/base.html" %}
{% load timer_filters %}

{% block title %}{{ project.name }} - Timer Tracker{% endblock %}

{% block breadcrumb %}
<div class="breadcrumb">
    <a href="{% url 'home' %}">Home</a>
    <span>â€º</span>
    <a href="{% url 'customer_list' %}">Customers</a>
    <span>â€º</span>
    <a href="{% url 'customer_detail' project.customer.pk %}">{{ project.customer.name }}</a>
    <span>â€º</span>
    <span>{{ project.name }}</span>
</div>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">
        <span class="customer-name-mobile-hide">{{ project.customer.name }} &nbsp;|&nbsp; </span>{{ project.name }}
    </h1>
    <div class="actions">
        {% if project.status == 'active' %}
        <a href="{% url 'timer_assign_to_project' %}?project={{ project.pk }}" class="btn btn-success">Assign Timer</a>
        <a href="{% url 'project_complete' project.pk %}" class="btn">Mark Complete</a>
        {% endif %}
        <a href="{% url 'project_edit' project.pk %}" class="btn btn-secondary">Edit</a>
    </div>
</div>

<div class="card">
    <h3>Details</h3>
    <p><strong>Customer:</strong> <a href="{% url 'customer_detail' project.customer.pk %}">{{ project.customer.name }}</a></p>
    <p><strong>Status:</strong> 
        <span class="status-badge status-{{ project.status }}">
            {{ project.get_status_display }}
        </span>
    </p>
    <p><strong>Total Time:</strong> {{ project.total_duration_seconds|format_duration }}</p>
    <p><strong>Total Cost:</strong> {{ project.total_cost|format_currency }}</p>
    <p><strong>Timers:</strong> {{ project_timers.count }}</p>
    <p><strong>Deliverables:</strong> 
        <a href="{% url 'deliverables:deliverable_list' project.pk %}">{{ project.deliverables.count }}</a>
        <a href="{% url 'deliverables:deliverable_add' project.pk %}" style="margin-left: 0.5rem; font-size: 0.875rem; color: #667eea;">+ Add</a>
    </p>
    <div style="margin-top: 1rem;">
        <a href="{% url 'project_summary' project.pk %}" class="btn">Summary</a>
    </div>
</div>

{% if project.status == 'completed' %}
<div class="message info" style="margin-top: 1rem;">
    This project is completed. You cannot start new timers on completed projects.
</div>
{% endif %}

<h2 style="margin-top: 2rem; margin-bottom: 1rem;">Timers</h2>

{% if project_timers %}
<div class="timer-grid">
    {% for project_timer in project_timers %}
    <div class="timer-card" data-timer-id="{{ project_timer.pk }}">
        <div class="timer-card-header" style="background-color: {{ project_timer.timer.header_color|default:'#3498db' }};">
            <h3 class="timer-task-name">{{ project_timer.timer.task_name }}</h3>
            <span class="timer-status {% if project_timer.is_running %}status-running{% elif project_timer.is_paused %}status-paused{% else %}status-stopped{% endif %}">
                {% if project_timer.is_paused %}PAUSED{% elif project_timer.is_running %}RUNNING{% else %}STOPPED{% endif %}
            </span>
        </div>
        
        <div class="timer-card-body">
            <div class="timer-info">
                <div class="timer-info-item">
                    <span class="timer-label">Rate:</span>
                    <span class="timer-value">{{ project_timer.timer.price_per_hour|format_currency }}/hr</span>
                </div>
                <div class="timer-info-item">
                    <span class="timer-label">Total Time:</span>
                    <span class="timer-value timer-total">{{ project_timer.total_duration_seconds|format_duration }}</span>
                </div>
                <div class="timer-info-item">
                    <span class="timer-label">Total Cost:</span>
                    <span class="timer-value">{{ project_timer.total_cost|format_currency }}</span>
                </div>
            </div>
            
            {% if project_timer.is_running or project_timer.is_paused %}
            <div class="timer-current-session">
                <span class="timer-label">Current Session:</span>
                {% if project_timer.is_paused %}
                <span class="timer-paused-display" data-timer-id="{{ project_timer.pk }}" data-start-time="{{ project_timer.active_session.start_time.isoformat }}" data-pause-time="{{ project_timer.active_session.pause_start_time.isoformat }}">
                    {{ project_timer.active_session.duration_seconds|format_duration }}
                </span>
                <span style="color: #e67e22; font-size: 0.875rem; margin-left: 0.5rem;">(Paused)</span>
                {% else %}
                <span class="live-timer" 
                      data-timer-id="{{ project_timer.pk }}" 
                      data-start-time="{{ project_timer.active_session.start_time.isoformat }}"
                      data-pauses="{% for pause in project_timer.active_session.pauses.all %}{{ pause.pause_start_time.isoformat }},{{ pause.pause_end_time.isoformat }};{% endfor %}">
                    00:00:00
                </span>
                {% endif %}
            </div>
            {% endif %}
            
            <div class="timer-actions">
                {% if project.status == 'active' %}
                    {% if project_timer.is_paused %}
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-success btn-timer-action resume-timer" data-timer-id="{{ project_timer.pk }}">
                            <i class="far fa-play-circle"></i> Resume
                        </button>
                        <button class="btn btn-danger btn-timer-action stop-timer" data-timer-id="{{ project_timer.pk }}">
                            <i class="far fa-stop-circle"></i> Stop
                        </button>
                    </div>
                    {% elif project_timer.is_running %}
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-warning btn-timer-action pause-timer" data-timer-id="{{ project_timer.pk }}">
                            <i class="far fa-pause-circle"></i> Pause
                        </button>
                        <button class="btn btn-danger btn-timer-action stop-timer" data-timer-id="{{ project_timer.pk }}">
                            <i class="far fa-stop-circle"></i> Stop
                        </button>
                    </div>
                    {% else %}
                    <button class="btn btn-success btn-timer-action start-timer" data-timer-id="{{ project_timer.pk }}">
                        <i class="far fa-play-circle"></i> Start Timer
                    </button>
                    {% endif %}
                {% endif %}
                
                <div class="timer-footer-actions">
                    <button class="btn-link toggle-sessions" data-timer-id="{{ project_timer.pk }}">
                        <span class="toggle-icon">â–¼</span> View Sessions ({{ project_timer.sessions.count }})
                    </button>
                    {% if is_owner %}
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <a href="{% url 'project_timer_remove' project_timer.pk %}" class="btn btn-small btn-danger">Remove</a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="timer-sessions-container" id="sessions-{{ project_timer.pk }}">
            <div class="sessions-header">
                <h4>Sessions</h4>
            </div>
            {% if project_timer.sessions.all %}
            <div class="sessions-list">
                {% for session in project_timer.sessions.all %}
                <div class="session-item">
                    <div class="session-time">
                        <div class="session-detail">
                            <strong>Started:</strong> {{ session.start_time|date:"M d, Y H:i" }}
                        </div>
                        <div class="session-detail">
                            <strong>Ended:</strong> 
                            {% if session.end_time %}
                                {{ session.end_time|date:"M d, Y H:i" }}
                            {% else %}
                                <span class="timer-running">ACTIVE</span>
                            {% endif %}
                        </div>
                        {% if has_team_members and session.created_by %}
                        <div class="session-creator-tag">
                            ðŸ‘¤ {{ session.created_by.username }}
                        </div>
                        {% endif %}
                        {% if session.pauses.all %}
                        <div class="session-pauses" style="margin-top: 0.75rem;">
                            <strong style="font-size: 0.875rem; color: #666;">Pauses:</strong>
                            <div style="margin-top: 0.5rem; padding-left: 0.5rem; border-left: 2px solid #e67e22;">
                                {% for pause in session.pauses.all %}
                                <div style="font-size: 0.875rem; color: #666; margin-bottom: 0.25rem;">
                                    {{ pause.pause_start_time|date:"M d, Y H:i" }} - {{ pause.pause_end_time|date:"M d, Y H:i" }}
                                    <span style="color: #999;">({{ pause.duration_seconds|format_duration }})</span>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    <div class="session-stats">
                        <span class="session-duration">{{ session.duration_seconds|format_duration }}</span>
                        <div class="session-cost-container">
                            <span class="session-cost">{{ session.cost|format_currency }}</span>
                            <span class="session-rate-recorded">Recorded at {{ session.price_per_hour|format_currency }}/hr</span>
                        </div>
                    </div>
                    <div class="session-deliverable-container" style="margin-bottom: 0.75rem;">
                        <label style="font-weight: 600; color: #666; font-size: 0.875rem; display: block; margin-bottom: 0.25rem;">Deliverable:</label>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <select class="session-deliverable-select form-input" data-session-id="{{ session.pk }}" style="flex: 1; font-size: 0.875rem;">
                                <option value="">No deliverable</option>
                                {% for deliverable in project.deliverables.all %}
                                <option value="{{ deliverable.pk }}" {% if session.deliverable and session.deliverable.pk == deliverable.pk %}selected{% endif %}>{{ deliverable.name }}</option>
                                {% endfor %}
                                <option value="__add_new__">âž• Add new deliverable...</option>
                            </select>
                            {% if session.deliverable %}
                            <a href="{% url 'deliverables:deliverable_detail' session.deliverable.pk %}" style="color: #667eea; text-decoration: none; font-weight: 500; font-size: 0.875rem;" title="View deliverable"></a>
                            {% endif %}
                        </div>
                        <div class="session-add-deliverable-inline" data-session-id="{{ session.pk }}" style="display: none; margin-top: 0.75rem; padding: 1rem; background: #f5f5f5; border-radius: 4px;">
                            <div class="form-group" style="margin-bottom: 0.75rem;">
                                <label class="form-label" style="font-size: 0.875rem;">Deliverable Name:</label>
                                <input type="text" class="new-deliverable-name form-input" placeholder="e.g., Video 1, Kitchen wall, Landing page">
                            </div>
                            <div class="form-group" style="margin-bottom: 0.75rem;">
                                <label class="form-label" style="font-size: 0.875rem;">Description (optional):</label>
                                <textarea class="new-deliverable-description form-input" rows="2" placeholder="Optional description..."></textarea>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button type="button" class="create-deliverable-session-btn btn" style="flex: 1; font-size: 0.875rem;">Create & Assign</button>
                                <button type="button" class="cancel-add-deliverable-session-btn btn btn-secondary" style="font-size: 0.875rem;">Cancel</button>
                            </div>
                        </div>
                    </div>
                    <div class="session-note-container">
                        <label style="font-weight: 600; color: #666; font-size: 0.875rem; display: block; margin-bottom: 0.25rem;">Note:</label>
                        <div class="session-note-editable" 
                             contenteditable="true" 
                             data-session-id="{{ session.pk }}"
                             data-original-note="{{ session.note|default:'' }}"
                             placeholder="Click to add a note...">{% if session.note %}{{ session.note|linebreaksbr|safe }}{% endif %}</div>
                        <div class="session-note-hint">Click to edit â€¢ Changes save automatically</div>
                    </div>
                    <div class="session-actions">
                        <a href="{% url 'session_edit' session.pk %}" class="btn btn-small btn-secondary">Edit Time</a>
                        {% if is_owner %}
                        <button class="btn btn-small btn-danger delete-session" data-session-id="{{ session.pk }}">Delete Session</button>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p style="padding: 1rem; color: #999;">No sessions yet</p>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="card">
    <p>No timers yet. 
        {% if project.status == 'active' %}
        <a href="{% url 'timer_assign_to_project' %}?project={{ project.pk }}">Assign your first timer</a>
        {% endif %}
    </p>
</div>
{% endif %}

<!-- Note Modal -->
<div id="noteModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">Add Session Note</div>
        <div id="modalErrorMessage" style="display: none; margin: 1rem; padding: 0.75rem; background: #fee; border: 1px solid #fcc; border-radius: 4px; color: #c33; font-size: 0.875rem;"></div>
        <div class="form-group">
            <label for="sessionDeliverable" class="form-label">Deliverable (optional):</label>
            <select id="sessionDeliverable" class="form-input">
                <option value="">No deliverable</option>
                {% for deliverable in project.deliverables.all %}
                <option value="{{ deliverable.pk }}">{{ deliverable.name }}</option>
                {% endfor %}
                <option value="__add_new__">âž• Add new deliverable...</option>
            </select>
            <div id="addDeliverableInline" style="display: none; margin-top: 0.75rem; padding: 1rem; background: #f5f5f5; border-radius: 4px;">
                <div id="deliverableError" style="display: none; margin-bottom: 0.75rem; padding: 0.5rem; background: #fee; border: 1px solid #fcc; border-radius: 4px; color: #c33; font-size: 0.875rem;"></div>
                <div class="form-group" style="margin-bottom: 0.75rem;">
                    <label for="newDeliverableName" class="form-label" style="font-size: 0.875rem;">Deliverable Name:</label>
                    <input type="text" id="newDeliverableName" class="form-input" placeholder="e.g., Video 1, Kitchen wall, Landing page">
                </div>
                <div class="form-group" style="margin-bottom: 0.75rem;">
                    <label for="newDeliverableDescription" class="form-label" style="font-size: 0.875rem;">Description (optional):</label>
                    <textarea id="newDeliverableDescription" class="form-input" rows="2" placeholder="Optional description..."></textarea>
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    <button type="button" id="createDeliverableBtn" class="btn" style="flex: 1;">Create & Select</button>
                    <button type="button" id="cancelAddDeliverableBtn" class="btn btn-secondary">Cancel</button>
                </div>
            </div>
        </div>
        <div class="form-group">
            <label for="sessionNote" class="form-label">What did you work on?</label>
            <textarea id="sessionNote" class="form-textarea" rows="4" placeholder="Describe what you worked on..."></textarea>
        </div>
        <div class="modal-footer">
            <button id="saveNote" class="btn">Save</button>
            <button id="cancelNote" class="btn btn-secondary">Cancel</button>
        </div>
    </div>
</div>

<!-- Delete Session Confirmation Modal -->
<div id="deleteSessionModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">Delete Session</div>
        <p style="margin: 1rem 0;">Are you sure you want to delete this session? This action cannot be undone.</p>
        <div class="modal-footer">
            <button id="confirmDeleteSession" class="btn btn-danger">Yes, Delete</button>
            <button id="cancelDeleteSession" class="btn btn-secondary">Cancel</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentSessionId = null;
    let editingSessionId = null;

    // Update live timers
    function updateLiveTimers() {
        const timers = document.querySelectorAll('.live-timer');
        timers.forEach(timer => {
            const startTime = new Date(timer.dataset.startTime);
            const now = new Date();
            let seconds = Math.floor((now - startTime) / 1000);
            
            // Subtract pause periods
            const pausesData = timer.dataset.pauses;
            if (pausesData) {
                const pauses = pausesData.split(';').filter(p => p.trim() !== '');
                pauses.forEach(pauseStr => {
                    if (pauseStr.includes(',')) {
                        const [pauseStartStr, pauseEndStr] = pauseStr.split(',');
                        const pauseStart = new Date(pauseStartStr);
                        const pauseEnd = new Date(pauseEndStr);
                        
                        // Only subtract if the pause period overlaps with the current time period
                        // Pause duration is the time between pause start and pause end
                        const pauseDuration = Math.floor((pauseEnd - pauseStart) / 1000);
                        seconds -= pauseDuration;
                    }
                });
            }
            
            // Ensure non-negative
            seconds = Math.max(0, seconds);
            timer.textContent = formatDuration(seconds);
        });
    }

    function formatDuration(seconds) {
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = seconds % 60;
        return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
    }

    // Toggle sessions dropdown
    document.querySelectorAll('.toggle-sessions').forEach(button => {
        button.addEventListener('click', function() {
            const timerId = this.dataset.timerId;
            const sessionsContainer = document.getElementById(`sessions-${timerId}`);
            const toggleIcon = this.querySelector('.toggle-icon');
            
            if (sessionsContainer.classList.contains('expanded')) {
                sessionsContainer.classList.remove('expanded');
                toggleIcon.classList.remove('rotated');
            } else {
                sessionsContainer.classList.add('expanded');
                toggleIcon.classList.add('rotated');
            }
        });
    });

    // Start timer
    document.querySelectorAll('.start-timer').forEach(button => {
        button.addEventListener('click', function() {
            const timerId = this.dataset.timerId;
            
            fetch(`/project-timers/${timerId}/start/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred starting the timer');
            });
        });
    });

    // Pause timer
    document.querySelectorAll('.pause-timer').forEach(button => {
        button.addEventListener('click', function() {
            const timerId = this.dataset.timerId;
            
            fetch(`/project-timers/${timerId}/pause/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred pausing the timer');
            });
        });
    });

    // Resume timer
    document.querySelectorAll('.resume-timer').forEach(button => {
        button.addEventListener('click', function() {
            const timerId = this.dataset.timerId;
            
            fetch(`/project-timers/${timerId}/resume/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred resuming the timer');
            });
        });
    });

    // Stop timer
    document.querySelectorAll('.stop-timer').forEach(button => {
        button.addEventListener('click', function() {
            const timerId = this.dataset.timerId;
            
            fetch(`/project-timers/${timerId}/stop/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentSessionId = data.session_id;
                    // Clear any previous errors when opening modal
                    document.getElementById('modalErrorMessage').style.display = 'none';
                    document.getElementById('modalErrorMessage').textContent = '';
                    document.getElementById('deliverableError').style.display = 'none';
                    document.getElementById('deliverableError').textContent = '';
                    document.getElementById('sessionNote').value = '';
                    document.getElementById('sessionDeliverable').value = '';
                    document.getElementById('addDeliverableInline').style.display = 'none';
                    const saveBtn = document.getElementById('saveNote');
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Save';
                    document.getElementById('noteModal').classList.add('active');
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred stopping the timer');
            });
        });
    });

    // Handle deliverable dropdown change in modal
    document.getElementById('sessionDeliverable').addEventListener('change', function() {
        const addDeliverableInline = document.getElementById('addDeliverableInline');
        const errorDiv = document.getElementById('deliverableError');
        if (this.value === '__add_new__') {
            addDeliverableInline.style.display = 'block';
            this.value = ''; // Reset to empty so it doesn't interfere
            // Clear any previous errors
            errorDiv.style.display = 'none';
            errorDiv.textContent = '';
        } else {
            addDeliverableInline.style.display = 'none';
            // Clear errors when hiding the form
            errorDiv.style.display = 'none';
            errorDiv.textContent = '';
        }
    });

    // Cancel add deliverable in modal
    document.getElementById('cancelAddDeliverableBtn').addEventListener('click', function() {
        document.getElementById('addDeliverableInline').style.display = 'none';
        document.getElementById('sessionDeliverable').value = '';
        document.getElementById('newDeliverableName').value = '';
        document.getElementById('newDeliverableDescription').value = '';
        // Clear errors
        const errorDiv = document.getElementById('deliverableError');
        errorDiv.style.display = 'none';
        errorDiv.textContent = '';
    });

    // Create deliverable inline in modal
    document.getElementById('createDeliverableBtn').addEventListener('click', function() {
        const name = document.getElementById('newDeliverableName').value.trim();
        const description = document.getElementById('newDeliverableDescription').value.trim();
        const errorDiv = document.getElementById('deliverableError');
        
        // Hide previous errors
        errorDiv.style.display = 'none';
        errorDiv.textContent = '';
        
        if (!name) {
            errorDiv.textContent = 'Please enter a deliverable name';
            errorDiv.style.display = 'block';
            return;
        }

        fetch(`/projects/{{ project.pk }}/deliverables/add-ajax/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ name: name, description: description })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Add to dropdown
                const select = document.getElementById('sessionDeliverable');
                const option = document.createElement('option');
                option.value = data.deliverable.id;
                option.textContent = data.deliverable.name;
                select.insertBefore(option, select.lastElementChild); // Insert before "Add new" option
                select.value = data.deliverable.id;
                
                // Hide inline form and clear errors
                document.getElementById('addDeliverableInline').style.display = 'none';
                document.getElementById('newDeliverableName').value = '';
                document.getElementById('newDeliverableDescription').value = '';
                errorDiv.style.display = 'none';
                errorDiv.textContent = '';
            } else {
                errorDiv.textContent = 'Error: ' + (data.error || 'Failed to create deliverable');
                errorDiv.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            errorDiv.textContent = 'An error occurred creating the deliverable';
            errorDiv.style.display = 'block';
        });
    });

    // Handle Enter key in note textarea: Enter = submit, Shift+Enter = new line
    const sessionNoteTextarea = document.getElementById('sessionNote');
    if (sessionNoteTextarea) {
        sessionNoteTextarea.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                // Trigger save button click
                const saveBtn = document.getElementById('saveNote');
                if (saveBtn && !saveBtn.disabled) {
                    saveBtn.click();
                }
            }
            // Shift+Enter allows default behavior (new line)
        });
    }

    // Save note (for new session)
    document.getElementById('saveNote').addEventListener('click', function() {
        const note = document.getElementById('sessionNote').value;
        const deliverableId = document.getElementById('sessionDeliverable').value;
        const errorDiv = document.getElementById('modalErrorMessage');
        
        // Hide previous errors
        errorDiv.style.display = 'none';
        errorDiv.textContent = '';
        
        // Don't save if "Add new" is selected
        if (deliverableId === '__add_new__') {
            errorDiv.textContent = 'Please create the deliverable first or select an existing one';
            errorDiv.style.display = 'block';
            return;
        }
        
        // Disable save button to prevent double submission
        const saveBtn = document.getElementById('saveNote');
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';
        
        fetch(`/sessions/${currentSessionId}/note/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                note: note,
                deliverable: deliverableId || null
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Only reload on success - this closes the modal
                location.reload();
            } else {
                // Show error and re-enable button
                errorDiv.textContent = 'Error: ' + (data.error || 'Failed to save session');
                errorDiv.style.display = 'block';
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            errorDiv.textContent = 'An error occurred saving the note';
            errorDiv.style.display = 'block';
            saveBtn.disabled = false;
            saveBtn.textContent = 'Save';
        });
    });

    // Cancel note
    document.getElementById('cancelNote').addEventListener('click', function() {
        // Clear all form data and errors
        document.getElementById('noteModal').classList.remove('active');
        document.getElementById('sessionNote').value = '';
        document.getElementById('sessionDeliverable').value = '';
        document.getElementById('addDeliverableInline').style.display = 'none';
        document.getElementById('newDeliverableName').value = '';
        document.getElementById('newDeliverableDescription').value = '';
        document.getElementById('modalErrorMessage').style.display = 'none';
        document.getElementById('modalErrorMessage').textContent = '';
        document.getElementById('deliverableError').style.display = 'none';
        document.getElementById('deliverableError').textContent = '';
        const saveBtn = document.getElementById('saveNote');
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save';
        // Reload to refresh the page state
        location.reload();
    });

    // Handle deliverable selector for existing sessions
    document.querySelectorAll('.session-deliverable-select').forEach(select => {
        // Store original value
        const originalValue = select.value;
        
        select.addEventListener('change', function() {
            const sessionId = this.dataset.sessionId;
            const value = this.value;
            const inlineForm = document.querySelector(`.session-add-deliverable-inline[data-session-id="${sessionId}"]`);
            
            if (value === '__add_new__') {
                inlineForm.style.display = 'block';
                // Store current value before resetting
                this.dataset.originalValue = this.value === '__add_new__' ? originalValue : this.value;
                this.value = ''; // Reset to empty so it doesn't interfere
            } else {
                inlineForm.style.display = 'none';
                // Update deliverable for session
                if (value) {
                    const selectElement = this;
                    fetch(`/sessions/${sessionId}/note/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrftoken,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ deliverable: value })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Reload page to refresh all data
                            location.reload();
                        } else {
                            alert('Error: ' + (data.error || 'Failed to update deliverable'));
                            // Reset select to original value
                            selectElement.value = selectElement.dataset.originalValue || '';
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred updating the deliverable');
                        // Reset select to original value
                        selectElement.value = selectElement.dataset.originalValue || '';
                    });
                } else {
                    // Remove deliverable
                    const selectElement = this;
                    fetch(`/sessions/${sessionId}/note/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrftoken,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ deliverable: null })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Reload page to refresh all data
                            location.reload();
                        } else {
                            alert('Error: ' + (data.error || 'Failed to update deliverable'));
                            // Reset select to original value
                            selectElement.value = selectElement.dataset.originalValue || '';
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred updating the deliverable');
                        // Reset select to original value
                        selectElement.value = selectElement.dataset.originalValue || '';
                    });
                }
            }
        });
    });

    // Cancel add deliverable for existing session
    document.querySelectorAll('.cancel-add-deliverable-session-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const inlineForm = this.closest('.session-add-deliverable-inline');
            const sessionId = inlineForm.dataset.sessionId;
            const select = document.querySelector(`.session-deliverable-select[data-session-id="${sessionId}"]`);
            
            inlineForm.style.display = 'none';
            // Restore original value if stored, otherwise empty
            select.value = select.dataset.originalValue || '';
            delete select.dataset.originalValue;
            
            // Clear form
            inlineForm.querySelector('.new-deliverable-name').value = '';
            inlineForm.querySelector('.new-deliverable-description').value = '';
        });
    });

    // Create deliverable inline for existing session
    document.querySelectorAll('.create-deliverable-session-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const inlineForm = this.closest('.session-add-deliverable-inline');
            const sessionId = inlineForm.dataset.sessionId;
            const name = inlineForm.querySelector('.new-deliverable-name').value.trim();
            const description = inlineForm.querySelector('.new-deliverable-description').value.trim();
            const select = document.querySelector(`.session-deliverable-select[data-session-id="${sessionId}"]`);
            
            if (!name) {
                alert('Please enter a deliverable name');
                return;
            }

            fetch(`/projects/{{ project.pk }}/deliverables/add-ajax/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ name: name, description: description })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Add to dropdown
                    const option = document.createElement('option');
                    option.value = data.deliverable.id;
                    option.textContent = data.deliverable.name;
                    select.insertBefore(option, select.lastElementChild);
                    select.value = data.deliverable.id;
                    
                    // Hide inline form
                    inlineForm.style.display = 'none';
                    inlineForm.querySelector('.new-deliverable-name').value = '';
                    inlineForm.querySelector('.new-deliverable-description').value = '';
                    
                    // Automatically assign to session
                    const selectElement = document.querySelector(`.session-deliverable-select[data-session-id="${sessionId}"]`);
                    fetch(`/sessions/${sessionId}/note/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrftoken,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ deliverable: data.deliverable.id })
                    })
                    .then(response => response.json())
                    .then(assignData => {
                        if (assignData.success) {
                            // Reload page to refresh all data
                            location.reload();
                        } else {
                            alert('Deliverable created but failed to assign to session. Please assign manually.');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Deliverable created but failed to assign to session. Please assign manually.');
                    });
                } else {
                    alert('Error: ' + (data.error || 'Failed to create deliverable'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred creating the deliverable');
            });
        });
    });

    // Inline edit session notes
    let saveTimeout = null;
    document.querySelectorAll('.session-note-editable').forEach(noteElement => {
        // Save on blur (when user clicks away)
        noteElement.addEventListener('blur', function() {
            const sessionId = this.dataset.sessionId;
            const originalNote = this.dataset.originalNote;
            const newNote = this.textContent.trim();
            
            // Only save if changed
            if (newNote !== originalNote) {
                this.classList.add('saving');
                
                fetch(`/sessions/${sessionId}/note/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ note: newNote })
                })
                .then(response => response.json())
                .then(data => {
                    this.classList.remove('saving');
                    if (data.success) {
                        this.dataset.originalNote = newNote;
                        // Show a brief success indicator
                        const hint = this.parentElement.querySelector('.session-note-hint');
                        const originalText = hint.textContent;
                        hint.textContent = 'âœ“ Saved';
                        hint.style.color = '#27ae60';
                        setTimeout(() => {
                            hint.textContent = originalText;
                            hint.style.color = '#999';
                        }, 2000);
                    } else {
                        alert('Error: ' + data.error);
                        this.textContent = originalNote;
                    }
                })
                .catch(error => {
                    this.classList.remove('saving');
                    console.error('Error:', error);
                    alert('An error occurred saving the note');
                    this.textContent = originalNote;
                });
            }
        });
        
        // Handle Enter key: Enter = blur/save, Shift+Enter = new line
        noteElement.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                this.blur(); // Trigger save
            }
            // Shift+Enter allows default behavior (creates line break)
        });
    });

    // Delete session - show modal
    let deletingSessionId = null;
    document.querySelectorAll('.delete-session').forEach(button => {
        button.addEventListener('click', function() {
            deletingSessionId = this.dataset.sessionId;
            document.getElementById('deleteSessionModal').classList.add('active');
        });
    });

    // Confirm delete session
    document.getElementById('confirmDeleteSession').addEventListener('click', function() {
        if (!deletingSessionId) return;
        
        fetch(`/sessions/${deletingSessionId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('deleteSessionModal').classList.remove('active');
                location.reload();
            } else {
                alert('Error: ' + (data.error || 'Failed to delete session'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred deleting the session');
        });
    });

    // Cancel delete session
    document.getElementById('cancelDeleteSession').addEventListener('click', function() {
        document.getElementById('deleteSessionModal').classList.remove('active');
        deletingSessionId = null;
    });

    // Close modals when clicking outside
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.remove('active');
            }
        });
    });

    // Close modals with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            document.querySelectorAll('.modal.active').forEach(modal => {
                modal.classList.remove('active');
            });
        }
    });

    // Update live timers every second
    setInterval(updateLiveTimers, 1000);
    updateLiveTimers();
</script>
{% endblock %}

